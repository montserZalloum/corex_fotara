This documentation is a comprehensive technical guide for integrating with the **Jordanian National Invoicing System (JoFotara)**. It combines the official technical requirements found in the PDF guides (v1.4) with practical implementation details derived from your working SQL Stored Procedure and XML sample.

---

# JoFotara E-Invoicing Integration Documentation

## 1. System Overview & Prerequisites
The JoFotara system uses the **OASIS UBL 2.1** XML standard wrapped in a JSON payload.

### Prerequisites
Before generating XMLs, you must:
1.  **Register** on the JoFotara portal.
2.  **Link a Device:** In the portal, go to "Link Devices" (ربط الأجهزة) to generate:
    *   `Client ID`
    *   `Secret Key`
3.  **API Endpoint:** `https://backend.jofotara.gov.jo/core/invoices/`

---

## 2. JSON Envelope & Headers
The API does not accept raw XML. You must wrap the Base64 encoded XML in a JSON object.

**HTTP Headers:**
*   `Client-Id`: [Your Client ID]
*   `Secret-Key`: [Your Secret Key]
*   `Content-Type`: `application/json`

**JSON Body Structure:**
```json
{
  "invoice": "Base64_Encoded_XML_String"
}
```

---

## 3. XML Structure (UBL 2.1)
The XML is the core of the invoice. Below is the mapping based on your SQL implementation and the PDF guide.

### 3.1. XML Namespaces (Standard)
Your SQL correctly defines these. They must remain exactly as follows:
```xml
<Invoice xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
         xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
         xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
         xmlns:ext="urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2">
```

### 3.2. Invoice Header Information
| XML Element | Value/Logic | SQL Source |
| :--- | :--- | :--- |
| `cbc:ProfileID` | `reporting:1.0` (Fixed) | Static String |
| `cbc:ID` | Invoice Serial Number (e.g., 1001) | `V.ARAPInvoiceCode` |
| `cbc:UUID` | Unique GUID for this specific invoice | `V.InvoiceGUID` |
| `cbc:IssueDate` | Format: `yyyy-MM-dd` | `FORMAT(V.InvoiceDate, 'yyyy-MM-dd')` |
| `cbc:InvoiceTypeCode` | **388** (Sales) or **381** (Return) | Static '388' in SQL (Needs logic for Returns) |
| `cbc:InvoiceTypeCode/@name`| **Sub-type Code** (See Section 4.1 below) | Static '012' in SQL |
| `cbc:DocumentCurrencyCode`| `JOD` | Static 'JOD' |
| `cbc:TaxCurrencyCode` | `JOD` | Static 'JOD' |

### 3.3. Invoice Note
*   `cbc:Note`: Optional free text note.

### 3.4. Additional Document Reference (ICV)
This is a counter for the invoice generated by your device/ERP.
*   `cac:AdditionalDocumentReference/cbc:ID`: Fixed `ICV`.
*   `cac:AdditionalDocumentReference/cbc:UUID`: The invoice number/counter (e.g., `V.ARAPInvoiceCode`).

---

## 4. Business Rules & Codes (From PDF Guide)

### 4.1. Invoice Type Codes (`cbc:InvoiceTypeCode`)
The main element defines the operation, the `name` attribute defines the specific type.

**Main Codes:**
*   `388`: Standard Invoice (Fatoora)
*   `381`: Return Invoice / Credit Note (Murtaja'a)

**Name Attribute Matrix (3 Digits):**
The SQL uses `012`. You should make this dynamic based on the transaction.

| Code | Type | Payment | Taxpayer Type | Description |
| :--- | :--- | :--- | :--- | :--- |
| **011** | Local | Cash | Income | Unregistered in Sales Tax |
| **021** | Local | Credit | Income | Unregistered in Sales Tax |
| **012** | Local | Cash | Sales | **Standard Sales Tax Invoice (Cash)** |
| **022** | Local | Credit | Sales | **Standard Sales Tax Invoice (Credit)** |
| **013** | Local | Cash | Special | Special Tax Invoice |
| **112** | Export | Cash | Sales | Export Invoice |

*Note: Digits definition: 1st (0=Local, 1=Export), 2nd (1=Cash, 2=Credit), 3rd (1=Income, 2=Sales, 3=Special).*

---

## 5. Party Information

### 5.1. Supplier (Seller) - `cac:AccountingSupplierParty`
Derived from your `Company` table.
*   **IdentificationCode:** `JO`
*   **CompanyID:** The Tax Registration Number (TRN).
*   **SchemeID:** `VAT`
*   **RegistrationName:** Official Company Name.

### 5.2. Customer (Buyer) - `cac:AccountingCustomerParty`
Derived from `ARAP_Defenition`.
*   **Identification/ID:**
    *   `NIN`: National ID (Individuals)
    *   `TN`: Tax Number (Companies)
    *   `PN`: Passport Number (Non-Residents)
*   **PostalZone:** PO Box or Postal Code.
*   **CountrySubentityCode:** City Code.
    *   *SQL uses hardcoded `JO-AM` (Amman).*
    *   *PDF Codes:* `JO-AM` (Amman), `JO-IR` (Irbid), `JO-AZ` (Zarqa), `JO-AQ` (Aqaba), etc.
*   **RegistrationName:** Customer Name.
*   **Telephone:** Required.

**Validation Rule:** If the invoice is **Credit** OR **Cash > 10,000 JOD**, the Customer Name is **Mandatory**.

### 5.3. Seller Supplier Party (Income Source)
*   `cac:SellerSupplierParty/cac:Party/cac:PartyIdentification/cbc:ID`: The Sequence of Income Source (تسلسل مصدر الدخل). This is obtained from the JoFotara portal settings.

---

## 6. Line Items & Calculations
The PDF Appendix dictates strict calculation rules (9 decimal places).

### 6.1. Line Structure (`cac:InvoiceLine`)
Loop through invoice details (`ARAPInvoiceD`).

| Element | Calculation / Value |
| :--- | :--- |
| `cbc:ID` | Row Number (1, 2, 3...) |
| `cbc:InvoicedQuantity` | Quantity (`unitCode="PCE"`) |
| `cbc:LineExtensionAmount` | `ROUND(Quantity * UnitPrice - Discount, 9)` |
| `cac:TaxTotal/cbc:TaxAmount` | `ROUND((Quantity * UnitPrice - Discount) * TaxPercent, 9)` |
| `cac:TaxTotal/cbc:RoundingAmount` | **Line Total (Inclusive):** `ROUND(LineExtensionAmount + TaxAmount, 9)` |
| `cac:Price/cbc:PriceAmount` | Unit Price **Exclusive** of Tax. |

### 6.2. Tax Categories (`cac:TaxCategory`)
The `cbc:ID` inside `TaxCategory` determines the tax type.
*   **S**: Standard Rate (e.g., 16%).
*   **Z**: Exempt (Zero Tax).
*   **O**: Zero Rated / Out of Scope (Zero Tax).

*SQL Logic:* Your SQL uses `CASE WHEN T.PercAmt IS NULL OR T.PercAmt = 0 THEN 'O' ELSE 'S' END`.

---

## 7. Return Invoices (Important)
The provided SQL generates a Standard Invoice (`388`). To support the XML sample you provided (Return Invoice), you must add the **Billing Reference** section.

**Logic:**
If `InvoiceType` is Return (381), you MUST include:
```xml
<cac:BillingReference>
    <cac:InvoiceDocumentReference>
        <cbc:ID>ORIGINAL_INVOICE_ID</cbc:ID>
        <cbc:UUID>ORIGINAL_INVOICE_UUID</cbc:UUID>
        <cbc:DocumentDescription>ORIGINAL_INVOICE_TOTAL_AMOUNT</cbc:DocumentDescription>
    </cac:InvoiceDocumentReference>
</cac:BillingReference>
```
*Also, include `<cac:PaymentMeans>` with code `10` (No Reason) or other standard codes for returns.*

---

## 8. Totals (`cac:LegalMonetaryTotal`)

*   **TaxExclusiveAmount:** Sum of all `LineExtensionAmount`.
*   **TaxInclusiveAmount:** Sum of all `RoundingAmount` (Line Totals).
*   **AllowanceTotalAmount:** Sum of global discounts (usually 0 at header level if handled at line level).
*   **PayableAmount:** Final amount to be paid (`TaxInclusiveAmount` - `PrepaidAmount`).

---

## 9. Updated SQL Recommendations
Your SQL is 90% there but needs adjustments to fully match the PDF requirements and support Returns.

1.  **Dynamic Invoice Type:**
    Change `'388' AS "cbc:InvoiceTypeCode"` to a CASE statement based on your transaction type (Sales vs Return).
2.  **Billing Reference (For Returns):**
    Add a conditional `CASE` or `IF` block to inject the `<cac:BillingReference>` XML node if the invoice is a return.
3.  **City Code:**
    Map your system's cities to the codes (`JO-AM`, `JO-IR`) instead of hardcoding `JO-AM`, if you have customers outside Amman.
4.  **Tax Scheme:**
    Ensure `T.PercAmt` logic handles Exempt items (`Z`) correctly if you deal with exempt goods, distinguishing them from Zero-rated (`O`).

## 10. Final Output Checklist
Before deploying, verify:
1.  [ ] **UUID** is unique per invoice.
2.  [ ] **ProfileID** is `reporting:1.0`.
3.  [ ] **LineExtensionAmount** is calculated *before* tax.
4.  [ ] **Tax amounts** use 3 decimal places in display but calculation supports high precision.
5.  [ ] **Return Invoices** reference the original invoice UUID.
6.  [ ] **QR Code** (Not in XML, but must be printed on the paper invoice after successful submission).